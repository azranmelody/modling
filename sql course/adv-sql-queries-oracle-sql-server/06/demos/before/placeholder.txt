/* Course Data */
/* Table: CHILDSTAT */
/* Database: Oracle */
DROP TABLE CHILDSTAT;
CREATE TABLE CHILDSTAT(FIRSTNAME VARCHAR2(50),GENDER VARCHAR2(1),BIRTHDATE DATE,HEIGHT NUMBER,WEIGHT NUMBER);
INSERT INTO CHILDSTAT VALUES('ROSEMARY','F',DATE '2000-05-08',35,123);     
INSERT INTO CHILDSTAT VALUES('LAUREN','F',DATE '2000-06-10',54,876);     
INSERT INTO CHILDSTAT VALUES('ALBERT','M',DATE '2000-08-02',45,150);     
INSERT INTO CHILDSTAT VALUES('BUDDY','M',DATE '1998-10-02',45,189);   
INSERT INTO CHILDSTAT VALUES('FARQUAR','M',DATE '1998-11-05',76,198);     
INSERT INTO CHILDSTAT VALUES('TOMMY','M',DATE '1998-12-11',78,167);     
INSERT INTO CHILDSTAT VALUES('SIMON','M',DATE '1999-01-03',87,256);

/* Course Data */
/* Table: CHILDSTAT */
/* Database: SQL Server */
DROP TABLE CHILDSTAT;
CREATE TABLE CHILDSTAT(FIRSTNAME VARCHAR(50),GENDER VARCHAR(1),BIRTHDATE SMALLDATETIME,HEIGHT SMALLINT,WEIGHT SMALLINT);
INSERT INTO CHILDSTAT VALUES('ROSEMARY','F','2000-05-08',35,123);     
INSERT INTO CHILDSTAT VALUES('LAUREN','F','2000-06-10',54,876);     
INSERT INTO CHILDSTAT VALUES('ALBERT','M','2000-08-02',45,150);     
INSERT INTO CHILDSTAT VALUES('BUDDY','M','1998-10-02',45,189);   
INSERT INTO CHILDSTAT VALUES('FARQUAR','M','1998-11-05',76,198);     
INSERT INTO CHILDSTAT VALUES('TOMMY','M','1998-12-11',78,167);     
INSERT INTO CHILDSTAT VALUES('SIMON','M','1999-01-03',87,256);

/* Non-Recursive WITH Clause */
/* Large SQL query that's a mess! */
SELECT A.FIRSTNAME AS FIRSTNAME_MALE, 
       A.WEIGHT AS WEIGHT_MALE,
       B.FIRSTNAME AS FIRSTNAME_FEMALE, 
       B.WEIGHT AS WEIGHT_FEMALE
 FROM (SELECT FIRSTNAME,WEIGHT,
              ROW_NUMBER() OVER (ORDER BY WEIGHT DESC) AS WT_RANK_MALE
        FROM FATKIDS
        WHERE GENDER='M') A 
      INNER JOIN 
      (SELECT FIRSTNAME,WEIGHT,
              ROW_NUMBER() OVER (ORDER BY WEIGHT DESC) AS WT_RANK_FEMALE
        FROM FATKIDS
        WHERE GENDER='F') B
 ON A.WT_RANK_MALE=B.WT_RANK_FEMALE

/* Using WITH Clauses to neaten up code */
WITH WT_M AS (SELECT FIRSTNAME,WEIGHT,
                     ROW_NUMBER() OVER (ORDER BY WEIGHT DESC) 
                                                        AS WT_RANK_MALE
               FROM FATKIDS
               WHERE GENDER='M'),
     WT_F AS (SELECT FIRSTNAME,WEIGHT,
                     ROW_NUMBER() OVER (ORDER BY WEIGHT DESC) 
                                                        AS WT_RANK_FEMALE
               FROM FATKIDS
               WHERE GENDER='F')
SELECT A.FIRSTNAME AS FIRSTNAME_MALE, 
       A.WEIGHT AS WEIGHT_MALE,
       B.FIRSTNAME AS FIRSTNAME_FEMALE, 
       B.WEIGHT AS WEIGHT_FEMALE
 FROM WT_M A INNER JOIN WT_F B
 ON A.WT_RANK_MALE=B.WT_RANK_FEMALE

/* Repeated use of a WITH Clause */
WITH WT_AVG AS (SELECT AVG(WEIGHT) AS AVG_WT
                 FROM FATKIDS)
SELECT A.FIRSTNAME,A.GENDER,A.HEIGHT,A.WEIGHT
 FROM FATKIDS A
 WHERE A.GENDER='M'
       AND A.HEIGHT>50
       AND A.WEIGHT<=(SELECT AVG_WT FROM WT_AVG)
UNION ALL
SELECT B.FIRSTNAME,B.GENDER,B.HEIGHT,B.WEIGHT
 FROM FATKIDS B
 WHERE B.GENDER='F'
       AND B.HEIGHT>=40
       AND B.WEIGHT>=(SELECT AVG_WT FROM WT_AVG)

/* Two examples of using WITH in its non-standard position */
/* ONLY WORKS IN ORACLE! */
/* DON'T DO THIS!!! */
SELECT A.FIRSTNAME,A.GENDER,A.HEIGHT,A.WEIGHT
 FROM (
       WITH HT_AVG AS (SELECT AVG(HEIGHT) AS AVG_HT FROM FATKIDS)
       SELECT *
        FROM FATKIDS
        WHERE HEIGHT>=(SELECT AVG_HT FROM HT_AVG)
      ) A
 WHERE A.WEIGHT>=50

SELECT A.FIRSTNAME,A.GENDER,A.HEIGHT,A.WEIGHT
 FROM FATKIDS A
 WHERE A.WEIGHT>=(WITH WT_AVG AS (SELECT AVG(WEIGHT) AS AVG_WT 
                                   FROM FATKIDS)
                   SELECT AVG_WT
                    FROM WT_AVG)

/* Using CREATE TABLE with a WITH Clause */
CREATE TABLE FATKIDS_REDUCED AS 
 WITH WT_AVG AS (SELECT AVG(WEIGHT) AS AVG_WT 
                  FROM FATKIDS)                 
 SELECT A.FIRSTNAME,A.GENDER,A.HEIGHT,A.WEIGHT
  FROM FATKIDS A
  WHERE A.GENDER='M' 
        AND A.HEIGHT>50
        AND A.WEIGHT<=(SELECT AVG_WT FROM WT_AVG)
 UNION ALL
 SELECT A.FIRSTNAME,A.GENDER,A.HEIGHT,A.WEIGHT
  FROM FATKIDS A
  WHERE A.GENDER='F' 
        AND A.HEIGHT>=40
        AND A.WEIGHT>=(SELECT AVG_WT FROM WT_AVG)

/* Using Previously Defined WITH Clause */
WITH AVG_WT_GENDER AS (SELECT GENDER,AVG(WEIGHT) AS AVG_WT_SEX
                        FROM FATKIDS
                        GROUP BY GENDER),
     AVG_WT_OVERALL AS (SELECT AVG(AVG_WT_SEX) AS AVG_WT_ALL 
                         FROM AVG_WT_GENDER)
 SELECT A.*
  FROM FATKIDS A
  WHERE A.WEIGHT>=(SELECT AVG_WT_ALL
                    FROM AVG_WT_OVERALL)
